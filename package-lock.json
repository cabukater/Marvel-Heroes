import { of } from 'rxjs';
import { HttpHeaders } from '@angular/common/http';

describe('getCharonResponse()', () => {
  let service: MyService;
  let httpClientSpy: { get: jest.Mock };
  
  beforeEach(() => {
    httpClientSpy = {
      get: jest.fn()
    };
    
    service = new MyService(httpClientSpy as any);
  });
  
  it('should transform the response and make a GET request using updated headers', (done) => {
    const caronResponseItem = { href: 'https://example.com/endpoint' };
    const headerParams = { key: 'Authorization', value: 'Bearer token' };
    
    const updatedHeader = new HttpHeaders().set('Authorization', 'Bearer token');
    const caronResponse = { href: 'https://example.com/endpoint', someData: 'someValue' };
    const expectedResponse = { endpoint: caronResponse.href, updateHeader: updatedHeader };
    
    httpClientSpy.get.mockReturnValue(of(caronResponse));
    
    service.getCharonResponse('relation', [headerParams]).pipe(
      mergeMap((data:{endpoint: string, updatedHeader: HttpHeaders}) => {
        return of(data);
      })
    ).subscribe((response) => {
      expect(httpClientSpy.get).toHaveBeenCalledWith(caronResponseItem.href, { headers: updatedHeader });
      expect(response).toEqual(expectedResponse);
      done();
    });
  });
});
